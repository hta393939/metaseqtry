# Metasequoia4用gpbエクスポートプラグイン

## 概要
 Metasequoia 4 Windows 64bit版で使用する
gpbファイル出力プラグインです。
gpbファイルは Hot Soup Processor 3.6 hgimg4 で採用されている
3Dモデルファイルです。.materialファイルも書き出します。

Windows 11 64bit版の Metasequoia 4.9.0a(64bit) で
ざっくり動作確認しています。


## インストール
https://github.com/hta393939/metaseqtry/releases/tag/0.10.2 ページから exportgpb.0.10.2.zip をダウンロードします。

メニューから「ヘルプ」→「プラグインについて」をクリックします。
「プラグインについて」ダイアログの「インストール」をクリックします。
さきほどダウンロードした exportgpb.0.10.2.zip ファイルを選択して
「開く」をクリックします。
リストに Export HSP GPB(*.gpb) が追加されたら成功です。


## エクスポート(出力)方法
メニューから「ファイル」→「名前をつけて保存」を選択し
「保存」ダイアログの「ファイルの種類」で
「HSP GPB(*.gpb)」を選択します。  
名前を指定して「保存」をクリックします。  
「GPB Export」ダイアログで「OK」をクリックしてファイル出力します。


## 推奨のファイル配置
例えば、C:\\hsp36\\sample\\hgimg4\\res フォルダに
モデルファイルとテクスチャファイルを配置します。  
モデルファイルが piyo.mqoz ファイルとして
piyo.gpb ファイルとしてエクスポートすると  
C:\\hsp36\\sample\\hgimg4\\res\\piyo.material ファイルと  
C:\\hsp36\\sample\\hgimg4\\piyo.hsp ファイルを
書き出します。


## 動作
### material ファイルの path
テクスチャプリフィクスに記載した内容に
テクスチャのパスを除いたファイル名を出力します。  
例えば、テクスチャプリフィクスが res/ で
テクスチャ設定が fuga/hoge.png だった場合は  
path = res/hoge.png  
が出力されます。
HSP3.x hgimg4 で使用する場合は
テクスチャプリフィクスは res/ を指定することを推奨します。


### ライティング
Constant, VRM1.0 MToon 材質では
ライティングを行わない .material ファイルを書き出します。
具体的には defines = DIRECTIONAL_LIGHT_COUNT 1 を出力しません。  
それ以外の材質ではライティング設定で出力します。
具体的には defines = DIRECTIONAL_LIGHT_COUNT 1 を出力します。

### 反射光
ライティングを行う材質の場合に
反射光の色設定そのものは反映されませんが
反射光の色が(0,0,0)以外の場合は
反射光を有効にする材質として .materialファイルを出力します。  
具体的には defines = SPECULAR;DIRECTIONAL_LIGHT_COUNT 1 が出力されます。

### ボーン
(0.3.1-)ボーンの位置と頂点ウェイトを出力できます。
アニメーションには非対応です。
ボーン名を指定して個別で回転することを想定しています。

## 試験的機能
### xmlアニメーションファイル読み込み
(0.7.1-)piyo.gpb ファイルを出力する際に同一フォルダの
piyo.xml ファイルをアニメーションファイルとして読み込みを試みます。  
ファイルはgpbconvが出力するxmlファイルと同等の構造と見做してパースします。   
gpb書き出しの際に参照ボーンの存在チェックは実施していません。
妥当性チェックは実施していません(すべてのボーンにキーバリューがセットされている必要があります)。


## 非対応
- 頂点カラーには非対応です。
- 材質拡散光以外には非対応です。
- 半角英数以外の文字を含む材質名には非対応です。
- 半角英数以外の文字を含むテクスチャファイル名には非対応です。
- png以外のテクスチャファイルには非対応です。
- テクスチャのミラーには非対応です。REPEAT として .material に書き出します。
- アニメーションには非対応です。
- 半角英数以外の文字を含むボーン名には非対応です。
- (0.3.1-) ボーン情報を出力できますが、ボーンの
  スケール、回転には非対応です。相対位置のみ反映されます。   
  (0.5.1-)また頂点ウェイトも4つのボーンまでしか反映されません。
- スキンの デュアルクオータニオン には非対応です。
 常にリニアとして処理されます。


## 免責
 本ファイル群を使用することによって生じる
いかなる結果、事象、損害について
当方では責任を負いません。


## 更新履歴

2024-12-30: ver.0.10.2 ボーン出力時に .hsp ファイルに回転と平行移動成分を書き出す。   
2024-12-29: ver.0.9.1 GUIを修正した。   
2024-12-28: ver.0.8.0 ビルド環境を v143 へ更新した。   
2024-11-16: ver.0.7.2 バグ修正: .xmlアニメーションファイル読み込みコードの反映漏れ。    
2024-11-14: ver.0.7.1 試験的に.xmlアニメーションファイルの読み込んで使用する機能を追加した。   
 スケール変換を廃止した。   
 ×で閉じたとき出力しないようにした。   
 材質名を変換する機能を追加した。   
2024-11-04: ver.0.6.2 65535個の面頂点制限を無くした。   
2024-10-31: ver.0.6.1 面頂点インデックスを4バイトで書き出すようにした。    
2024-10-26: ver.0.5.1 ボーン有りの場合に最大4ボーンウェイトまで格納するようにした。   
2024-10-20: ver.0.4.3 バグ修正: ボーン位置がスケーリングされていなかった。    
2024-10-19: ver.0.4.2 テクスチャ境界処理がミラー指定の場合は REPEAT として書き出す。
2024-10-17: ver.0.4.1 テクスチャの境界処理を .material に反映するようにした   
2024-10-14: ver.0.3.2 .hsp コードでボーンがある場合にすべてを回転する   
 バグ修正: ジョイントノードで不正な余計な値を書き出していた。   
 バグ修正: 無変化値の判定位置が早すぎた。  
2024-10-13: ver.0.3.1 Constant 材質の場合、基本色をそのまま diffuse に設定する   
  ボーンとスキニングに対応。アニメーションには対応していない。  
2024-10-06: ver.0.2.1 ライティング無し条件を追加  
2024-10-03: ver.0.1.2 初回リリース  
